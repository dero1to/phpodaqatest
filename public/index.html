<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PHP„Ç´„É≥„Éï„Ç°„É¨„É≥„ÇπÂ∞èÁî∞Âéü2026 - Q&A</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sen:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans JP', 'Sen', sans-serif;
      line-height: 1.6;
      color: #474747;
      background: linear-gradient(135deg, #FFEDF2 0%, #FFFAF0 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #FFFFFF;
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(252, 97, 141, 0.1);
      padding: 40px;
    }

    h1 {
      font-family: 'Sen', sans-serif;
      color: #FC618D;
      margin-bottom: 32px;
      text-align: center;
      font-size: 2.5rem;
      font-weight: 700;
    }

    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .search-box {
      flex: 1;
      min-width: 200px;
      padding: 12px 20px;
      border: 2px solid #FFEDF2;
      border-radius: 999px;
      font-size: 16px;
      font-family: 'Noto Sans JP', sans-serif;
      transition: all 0.3s ease;
    }

    .search-box:focus {
      outline: none;
      border-color: #FC618D;
      box-shadow: 0 0 0 3px rgba(252, 97, 141, 0.1);
    }

    .btn {
      padding: 12px 32px;
      background: #FC618D;
      color: white;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      font-family: 'Sen', sans-serif;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(252, 97, 141, 0.2);
    }

    .btn:hover {
      background: #FA4A7E;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(252, 97, 141, 0.3);
    }

    .loading {
      text-align: center;
      padding: 60px;
      font-size: 18px;
      color: #474747;
      font-weight: 500;
    }

    .error {
      background: #FFEDF2;
      color: #FC618D;
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 24px;
      border: 2px solid #FC618D;
      font-weight: 500;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid #FFEDF2;
    }

    th {
      background: #FFFAF0;
      font-weight: 700;
      color: #FC618D;
      position: sticky;
      top: 0;
      font-family: 'Sen', sans-serif;
    }

    tr:hover {
      background: #FFFAF0;
    }

    .no-data {
      text-align: center;
      padding: 60px;
      color: #474747;
      font-size: 18px;
      font-weight: 500;
    }

.sort-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .sort-label {
      font-weight: 600;
      color: #474747;
      font-family: 'Noto Sans JP', sans-serif;
    }

    .sort-btn {
      padding: 8px 20px;
      background: #FFFAF0;
      color: #474747;
      border: 2px solid transparent;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      font-family: 'Sen', sans-serif;
      transition: all 0.3s ease;
    }

    .sort-btn:hover {
      border-color: #FC618D;
    }

    .sort-btn.active {
      background: #FC618D;
      color: white;
      box-shadow: 0 4px 12px rgba(252, 97, 141, 0.2);
    }

    .last-updated {
      margin-left: auto;
      font-size: 14px;
      color: #474747;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .update-label {
      font-weight: 600;
      color: #474747;
    }

    #lastUpdated {
      color: #FC618D;
      font-weight: 500;
    }

    .good-btn {
      background: #FFFFFF;
      border: 2px solid #FFEDF2;
      color: #FC618D;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      min-width: 60px;
      justify-content: center;
    }

    .good-btn:hover:not(:disabled) {
      background: #FFEDF2;
      border-color: #FC618D;
      transform: scale(1.05);
    }

    .good-btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    .good-btn:disabled {
      background: #F0F0F0;
      border-color: #E0E0E0;
      color: #999;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .good-btn.voted {
      background: #FC618D;
      color: white;
      border-color: #FC618D;
    }

    @keyframes voteAnimation {
      0% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.2) rotate(5deg); }
      50% { transform: scale(1.1) rotate(-5deg); }
      75% { transform: scale(1.15) rotate(3deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    .good-btn.animating {
      animation: voteAnimation 0.5s ease-in-out;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé§ PHP„Ç´„É≥„Éï„Ç°„É¨„É≥„ÇπÂ∞èÁî∞Âéü2026 Q&A</h1>

    <div class="controls">
      <input type="text" id="searchInput" class="search-box" placeholder="Ê§úÁ¥¢...">
      <button class="btn" onclick="loadData()">„Éá„Éº„Çø„ÇíÊõ¥Êñ∞</button>
    </div>

    <div class="sort-controls">
      <span class="sort-label">‰∏¶„Å≥È†Ü:</span>
      <button class="sort-btn active" onclick="setSortMode('good')">GoodÊï∞È†Ü</button>
      <button class="sort-btn" onclick="setSortMode('id')">IDÈ†Ü</button>
      <span class="last-updated" id="lastUpdatedContainer" style="display: none;">
        <span class="update-label">ÊúÄÁµÇÊõ¥Êñ∞:</span>
        <span id="lastUpdated">-</span>
      </span>
    </div>

    <div id="loading" class="loading">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
    <div id="error" class="error" style="display: none;"></div>
    <div id="dataContainer"></div>
  </div>

  <script>
    let allData = [];
    let filteredData = [];
    let currentSortMode = 'good'; // „Éá„Éï„Ç©„É´„Éà„ÇíGoodÊï∞È†Ü„Å´Â§âÊõ¥
    let votedQuestions = JSON.parse(localStorage.getItem('votedQuestions') || '{}');
    let localGoodCounts = JSON.parse(localStorage.getItem('localGoodCounts') || '{}');

    function setSortMode(mode) {
      currentSortMode = mode;
      document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      sortAndRenderData();
    }

    function sortAndRenderData() {
      // Ê§úÁ¥¢„Éï„Ç£„É´„Çø„ÇíÈÅ©Áî®
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      if (searchTerm) {
        filteredData = allData.filter(item => {
          return Object.values(item).some(value =>
            String(value).toLowerCase().includes(searchTerm)
          );
        });
      } else {
        filteredData = [...allData];
      }

      // „ÇΩ„Éº„Éà„ÇíÈÅ©Áî®
      if (currentSortMode === 'good') {
        // GoodÂàóÔºàÈÄöÂ∏∏„ÅØ3Áï™ÁõÆ„Åã4Áï™ÁõÆ„ÅÆ„Ç´„É©„É†Ôºâ„ÅßÈôçÈ†Ü„ÇΩ„Éº„Éà
        filteredData.sort((a, b) => {
          const keys = Object.keys(a);
          // GoodÂàó„ÇíÊé¢„ÅôÔºà"Good"„Å®„ÅÑ„ÅÜÂêçÂâç„ÅÆ„Ç´„É©„É†„ÇíÊé¢„ÅôÔºâ
          let goodKey = keys.find(key => key.toLowerCase().includes('good'));
          if (!goodKey && keys.length >= 3) {
            // Good„Å®„ÅÑ„ÅÜÂêçÂâç„ÅÆ„Ç´„É©„É†„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅ3Áï™ÁõÆ„ÅÆ„Ç´„É©„É†„Å®‰ªÆÂÆö
            goodKey = keys[2];
          }

          // localGoodCounts„ÅÆÂÄ§„ÇíÂÑ™ÂÖàÁöÑ„Å´‰ΩøÁî®
          const aId = getQuestionId(a);
          const bId = getQuestionId(b);
          const aValue = localGoodCounts[aId] !== undefined
            ? localGoodCounts[aId]
            : parseInt(a[goodKey] || '0', 10);
          const bValue = localGoodCounts[bId] !== undefined
            ? localGoodCounts[bId]
            : parseInt(b[goodKey] || '0', 10);

          return bValue - aValue; // ÈôçÈ†Ü
        });
      } else if (currentSortMode === 'id') {
        // IDÈ†ÜÔºàAÂàóÔºâ„Åß„ÇΩ„Éº„Éà
        filteredData.sort((a, b) => {
          const aId = getQuestionId(a);
          const bId = getQuestionId(b);

          // Êï∞ÂÄ§„Å®„Åó„Å¶ÊØîËºÉ„ÇíË©¶„Åø„Çã
          const aNum = parseInt(aId, 10);
          const bNum = parseInt(bId, 10);

          if (!isNaN(aNum) && !isNaN(bNum)) {
            return aNum - bNum; // Êï∞ÂÄ§„ÅÆÊòáÈ†Ü
          }

          // ÊñáÂ≠óÂàó„Å®„Åó„Å¶ÊØîËºÉ
          return aId.localeCompare(bId); // ÊñáÂ≠óÂàó„ÅÆÊòáÈ†Ü
        });
      }

      renderData();
    }

    async function loadData() {
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const container = document.getElementById('dataContainer');
      const stats = document.getElementById('stats');

      loading.style.display = 'block';
      error.style.display = 'none';
      container.innerHTML = '';
      document.getElementById('lastUpdatedContainer').style.display = 'none';

      try {
        const response = await fetch('/api/sheets?t=' + Date.now());

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.error) {
          throw new Error(result.error);
        }

        allData = result.data || [];
        filteredData = [...allData];

        updateStats();
        sortAndRenderData();

        loading.style.display = 'none';
        document.getElementById('lastUpdatedContainer').style.display = 'inline-flex';

      } catch (err) {
        loading.style.display = 'none';
        error.style.display = 'block';
        error.textContent = `„Ç®„É©„Éº: ${err.message}`;
        console.error('Error loading data:', err);
      }
    }

    function updateStats() {
      document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString('ja-JP');
    }

    function renderData() {
      const container = document.getElementById('dataContainer');

      if (filteredData.length === 0) {
        container.innerHTML = '<div class="no-data">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        return;
      }

      renderTableView(container);
    }

    function renderTableView(container) {
      const headers = Object.keys(filteredData[0]);

      let html = '<div class="table-container"><table><thead><tr>';
      headers.forEach(header => {
        html += `<th>${escapeHtml(header)}</th>`;
      });
      html += '<th>„Ç¢„ÇØ„Ç∑„Éß„É≥</th>';
      html += '</tr></thead><tbody>';

      filteredData.forEach((row, index) => {
        html += '<tr>';
        headers.forEach((header, colIndex) => {
          let value = row[header] || '';

          // GoodÂàó„ÅÆÂ†¥Âêà„ÄÅ„É≠„Éº„Ç´„É´„ÅÆÂÄ§„ÇíÂÑ™ÂÖà
          if (header.toLowerCase().includes('good') || colIndex === 2) {
            const questionId = getQuestionId(row);
            if (localGoodCounts[questionId] !== undefined) {
              value = localGoodCounts[questionId];
            }
          }

          html += `<td>${escapeHtml(value)}</td>`;
        });

        // Good„Éú„Çø„É≥„ÇíËøΩÂä†
        const questionId = getQuestionId(row);
        const isVoted = votedQuestions[questionId] || false;
        const goodKey = headers.find(key => key.toLowerCase().includes('good')) || headers[2];
        const currentGoodCount = localGoodCounts[questionId] !== undefined
          ? localGoodCounts[questionId]
          : parseInt(row[goodKey] || '0', 10);

        html += `<td>
          <button class="good-btn ${isVoted ? 'voted' : ''}"
                  data-question-id="${escapeHtml(questionId)}"
                  data-row-index="${index}"
                  data-original-row="${escapeHtml(JSON.stringify(row))}"
                  onclick="handleGoodClick(this)"
                  ${isVoted ? 'disabled' : ''}>
            üëç ${currentGoodCount}
          </button>
        </td>`;
        html += '</tr>';
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function getQuestionId(row) {
      // AÂàóÔºàÊúÄÂàù„ÅÆ„Ç´„É©„É†Ôºâ„ÅÆ„É¶„Éã„Éº„ÇØID„Çí‰ΩøÁî®
      const keys = Object.keys(row);
      if (keys.length > 0) {
        return row[keys[0]]; // AÂàó„ÅÆÂÄ§„Çí„Åù„ÅÆ„Åæ„ÅæID„Å®„Åó„Å¶‰ΩøÁî®
      }
      // AÂàó„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
      return 'unknown_' + Math.random().toString(36).substr(2, 9);
    }

    async function handleGoodClick(button) {
      const questionId = button.dataset.questionId;
      const rowIndex = parseInt(button.dataset.rowIndex, 10);
      const originalRow = JSON.parse(button.dataset.originalRow);

      if (votedQuestions[questionId]) {
        return;
      }

      // AÂàó„ÅÆID„ÅåÂ≠òÂú®„Åô„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
      if (!questionId || questionId === 'unknown_' || questionId.startsWith('unknown_')) {
        alert('„Åì„ÅÆË≥™Âïè„Å´„ÅØID„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
        return;
      }

      // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
      button.classList.add('animating');

      // „É≠„Éº„Ç´„É´„ÅßÂç≥Â∫ß„Å´Êõ¥Êñ∞
      const currentCount = parseInt(button.textContent.replace('üëç', '').trim(), 10);
      const newCount = currentCount + 1;
      button.textContent = `üëç ${newCount}`;
      button.classList.add('voted');
      button.disabled = true;

      // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
      votedQuestions[questionId] = true;
      localGoodCounts[questionId] = newCount;
      localStorage.setItem('votedQuestions', JSON.stringify(votedQuestions));
      localStorage.setItem('localGoodCounts', JSON.stringify(localGoodCounts));

      // „Éá„Éº„ÇøÈÖçÂàó„ÇÇÊõ¥Êñ∞
      const row = filteredData[rowIndex];
      const headers = Object.keys(row);
      const goodKey = headers.find(key => key.toLowerCase().includes('good')) || headers[2];
      if (goodKey) {
        row[goodKey] = newCount.toString();

        // allData„ÇÇÊõ¥Êñ∞
        const originalRow = allData.find(r => getQuestionId(r) === questionId);
        if (originalRow) {
          originalRow[goodKey] = newCount.toString();
        }
      }

      // „Çµ„Éº„Éê„Éº„Å´ÈÄÅ‰ø°Ôºà„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßÔºâ
      try {
        await fetch('/api/vote', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            questionId: questionId,
            rowIndex: rowIndex
          })
        });
      } catch (error) {
        console.error('Vote submission error:', error);
        // „Ç®„É©„Éº„Åå„ÅÇ„Å£„Å¶„ÇÇ„É≠„Éº„Ç´„É´„ÅÆÁä∂ÊÖã„ÅØÁ∂≠ÊåÅ
      }

      // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫Ü
      setTimeout(() => {
        button.classList.remove('animating');
      }, 500);

      // „ÇΩ„Éº„Éà„ÇíÊõ¥Êñ∞
      if (currentSortMode === 'good') {
        setTimeout(() => {
          sortAndRenderData();
        }, 600);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function filterData(searchTerm) {
      if (!searchTerm) {
        filteredData = [...allData];
      } else {
        const term = searchTerm.toLowerCase();
        filteredData = allData.filter(row => {
          return Object.values(row).some(value =>
            String(value).toLowerCase().includes(term)
          );
        });
      }

      updateStats();
      sortAndRenderData();
    }

    document.getElementById('searchInput').addEventListener('input', (e) => {
      filterData(e.target.value);
    });

    window.addEventListener('load', loadData);
  </script>
</body>
</html>